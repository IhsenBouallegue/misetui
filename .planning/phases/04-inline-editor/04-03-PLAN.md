---
phase: 04-inline-editor
plan: 03
type: execute
wave: 3
depends_on:
  - "04-02"
files_modified:
  - src/ui/editor.rs
  - src/ui/mod.rs
  - src/ui/popup.rs
  - src/ui/footer.rs
autonomous: false
requirements:
  - EDIT-01
  - EDIT-02
  - EDIT-03
  - EDIT-04
  - EDIT-05
  - EDIT-06
  - EDIT-07

must_haves:
  truths:
    - "Editor popup renders as a centered overlay with dimmed background showing three sub-tabs (Tools/Env/Tasks)"
    - "Tools sub-tab shows a table with Name | Version | Status columns"
    - "Env sub-tab shows a table with Key | Value columns"
    - "Tasks sub-tab shows a table with Name | Command columns"
    - "Modified/Added/Deleted rows are visually distinguished (color-coded status markers)"
    - "When editing a cell, a cursor appears in the cell with the edit buffer text"
    - "Footer hints update to show editor-specific keybindings"
    - "Help popup documents the 'e' keybinding for opening the editor"
  artifacts:
    - path: "src/ui/editor.rs"
      provides: "render_editor() popup renderer with sub-tab and inline editing display"
      contains: "render_editor"
    - path: "src/ui/mod.rs"
      provides: "editor module declaration"
      contains: "mod editor"
    - path: "src/ui/popup.rs"
      provides: "Popup::Editor arm delegating to editor::render_editor"
      contains: "render_editor"
    - path: "src/ui/footer.rs"
      provides: "Editor-specific footer hints for e/a/d/w keys"
      contains: "editor"
  key_links:
    - from: "src/ui/popup.rs"
      to: "src/ui/editor.rs"
      via: "Popup::Editor arm calls super::editor::render_editor()"
      pattern: "editor::render_editor"
    - from: "src/ui/editor.rs"
      to: "src/model.rs"
      via: "Reads EditorState from Popup::Editor for rendering"
      pattern: "EditorState"
---

<objective>
Create the visual renderer for the inline editor popup: a centered overlay with sub-tab navigation, table-style rows for tools/env/tasks, inline edit cursor, change-status color markers, and updated footer/help text.

Purpose: Completes the user-visible experience of the inline editor. After this plan, users can see and interact with the full editor UI. A human verification checkpoint confirms the visual quality.

Output: editor.rs renderer, popup.rs delegation, footer hints, help text update.
</objective>

<execution_context>
@/home/ihsen/.claude/get-shit-done/workflows/execute-plan.md
@/home/ihsen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-inline-editor/04-CONTEXT.md
@.planning/phases/04-inline-editor/04-02-SUMMARY.md

@src/ui/popup.rs
@src/ui/mod.rs
@src/ui/footer.rs
@src/ui/wizard.rs
@src/model.rs
@src/theme.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create editor.rs renderer, wire into popup.rs and mod.rs, update footer and help</name>
  <files>src/ui/editor.rs, src/ui/mod.rs, src/ui/popup.rs, src/ui/footer.rs</files>
  <action>
1. Create src/ui/editor.rs with a `pub fn render_editor(f: &mut Frame, state: &EditorState)` function. Follow the same popup rendering pattern as wizard.rs (centered overlay, Clear background, Block with border).

Layout structure for the editor popup (centered, ~72 wide x 26 tall):
```
+-- Editor: /path/to/.mise.toml --+
| [Tools]  [Env]  [Tasks]         |  <- sub-tab bar, active tab highlighted
|                                  |
| Name         Version     Status  |  <- column headers (Tools tab)
| node         20.1.0      ●      |  <- row (unchanged = dim)
| python       3.12        ✎      |  <- row (modified = yellow)
| rust         stable      +      |  <- row (added = green)
| go           latest      ✗      |  <- row (deleted = red, strikethrough)
|                                  |
| e edit  a add  d delete  w write |  <- inline hints
+----------------------------------+
```

Implementation details:

a) `centered_rect` helper — duplicate from popup.rs (same pattern as wizard.rs, per Phase 03 decision).

b) Sub-tab bar: Render three Spans "Tools", "Env", "Tasks". The active tab gets `theme::title()` style with underline or bright color. Inactive tabs get `theme::muted()`.

c) Column headers: Render as a Line with styled Spans. Different headers per sub-tab:
   - Tools: "  Name", "Version", "Status"
   - Env: "  Key", "Value"
   - Tasks: "  Name", "Command"

d) Row rendering: Use a List widget with ListState for selection highlighting.
   - For each row, determine the style based on EditorRowStatus:
     - Unchanged: `theme::table_row()` (default)
     - Modified: Yellow foreground (use `ratatui::style::Color::Yellow`)
     - Added: Green foreground (use `theme::GREEN` constant)
     - Deleted: Red foreground with strikethrough modifier (use `ratatui::style::Color::Red`)
   - Status marker column (rightmost):
     - Unchanged: dim dot "·"
     - Modified: yellow "~"
     - Added: green "+"
     - Deleted: red "x"
   - When `state.editing` is true and the row index matches `state.selected`:
     - Replace the cell content with `state.edit_buffer` + "█" cursor character
     - Highlight the editing cell with `theme::search_input()` style

e) Inline edit indicator: When editing, show a small hint below the table: "Enter confirm  Esc cancel"

f) Bottom hints bar: "e edit  a add  d delete  w write  h/l tab  Esc close"
   If state.dirty, show a "(modified)" indicator in the title bar.

g) Empty state: If the active sub-tab has no rows, show "  (empty — press a to add)" in `theme::muted()`.

2. In src/ui/mod.rs, add `pub(crate) mod editor;` (or just `mod editor;` — follow same visibility as wizard which uses `pub(crate) mod wizard`).

3. In src/ui/popup.rs, replace the placeholder `Popup::Editor` arm with delegation to the editor renderer:
```rust
Popup::Editor(ref state) => {
    super::editor::render_editor(f, state);
}
```

4. In src/ui/footer.rs, add editor-specific hints. The editor is a popup, and when it's active the footer should show editor hints. Check if popup is Editor:

In the footer render function, add a check at the top (before the tab-based hints):
```rust
// If editor popup is active, show editor-specific hints
if let Some(crate::app::Popup::Editor(ref state)) = app.popup {
    let hints = if state.editing {
        vec![("Enter", "confirm"), ("Esc", "cancel")]
    } else {
        let mut h = vec![
            ("h/l", "switch tab"),
            ("j/k", "navigate"),
            ("e", "edit"),
            ("d", "delete"),
            ("w", "write"),
            ("Esc", "close"),
        ];
        match state.tab {
            crate::model::EditorTab::Tools => h.insert(3, ("a", "add tool")),
            crate::model::EditorTab::Env => h.insert(3, ("A", "add env")),
            crate::model::EditorTab::Tasks => h.insert(3, ("T", "add task")),
        }
        h
    };
    // ... render hints the same way as the normal footer
    // (reuse the spans-from-hints pattern already in footer.rs)
}
```

Actually, looking at the footer code more carefully, the popup-specific hints should short-circuit the function. Add an early return block at the start of the render function body, after the initial `hints` vector is built but before the tab match. Actually the cleanest approach: add the check BEFORE the initial hints vector. If editor popup is active, build editor-specific hints and render + return early, similar to how `search_active` replaces hints at the bottom.

5. In the render_help function in popup.rs, add the 'e' keybinding to the help text:
```
"    e            Edit config (Config/Projects)",
```
Add this in the "Actions" section, after the existing entries.

6. Also add 'e' hint to the Config and Projects tab hints in footer.rs:
```rust
Tab::Config => {
    hints.push(("t", "trust"));
    hints.push(("e", "edit"));
}
```
And in the Projects tab section, add `hints.push(("e", "edit config"));` (only makes sense when on a project with config).
  </action>
  <verify>
    <automated>cd /home/ihsen/Documents/repos/misetui && cargo check 2>&1 | tail -5</automated>
    <manual>Run the app with `cargo run`, navigate to Config tab, press 'e' on a config file, and verify the editor popup renders with sub-tabs, table rows, and correct keybindings</manual>
  </verify>
  <done>
- editor.rs renders a centered popup with Tools/Env/Tasks sub-tabs as a tabbed table view
- Modified rows show yellow, added rows show green, deleted rows show red with markers
- Inline editing shows cursor and edit buffer in the cell
- popup.rs delegates Popup::Editor to editor::render_editor
- mod.rs declares the editor module
- footer.rs shows editor-specific hints when editor popup is active
- help popup documents 'e' keybinding
- 'e' hint appears in Config and Projects tab footers
- cargo check passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify inline editor visual quality and full workflow</name>
  <files>n/a</files>
  <action>
Human verification of the complete inline TOML editor. What was built:
- Three sub-tabs (Tools/Env/Tasks) switchable with h/l
- Table rows showing name/version/key/value/command columns
- Inline editing with cursor (Enter to confirm, Esc to cancel)
- Add tool (a), add env var (A), add task (T) with inline name+value entry
- Delete row (d) with visual marking
- Write changes (w) with atomic toml_edit round-trip preservation
- Unsaved changes guard on Esc
- Color-coded change markers (yellow=modified, green=added, red=deleted)
- Footer hints context-sensitive to editor mode
- Help popup documents 'e' keybinding

Steps to verify:
1. Run `cargo run` in a directory with a `.mise.toml` that has [tools], [env], and [tasks] sections
2. Navigate to the Config tab, select a config file, press 'e' — editor popup should open on Tools sub-tab
3. Press h/l to switch between Tools, Env, Tasks sub-tabs — verify each shows the correct columns
4. On Tools tab: press j/k to navigate rows, press 'e' to edit a version, type a new version, press Enter — row should turn yellow with "~" marker
5. Press 'a' to add a new tool — type a name, press Enter, type a version, press Enter — row should be green with "+" marker
6. Press 'd' on a row — it should turn red with "x" marker
7. Press 'w' to write — verify the file is saved (check with cat), comments are preserved, and the app refreshes
8. Re-open editor, make a change, press Esc — verify "Unsaved changes. Discard?" dialog appears
9. Verify the footer shows editor-specific hints (e/a/d/w/h/l/Esc)
10. Press '?' to verify help popup lists the 'e' keybinding
11. Navigate to Projects tab, select a project with .mise.toml, press 'e' — editor should open for that project's config
  </action>
  <verify>Human visual verification — all 11 test steps pass</verify>
  <done>All EDIT-01 through EDIT-09 requirements verified: editor opens from Config/Projects tabs, sub-tabs work, inline editing works, add/edit/delete work, write preserves formatting, unsaved changes guard works, app refreshes after write</done>
</task>

</tasks>

<verification>
1. `cargo check` passes
2. Editor popup renders correctly with centered overlay, sub-tabs, and table rows
3. All three sub-tabs display the correct data from the parsed .mise.toml
4. Inline editing shows cursor in the cell being edited
5. Change markers are color-coded (yellow/green/red)
6. Footer hints update based on editor state (normal vs editing mode)
7. Help popup documents the 'e' keybinding
8. Full workflow: open editor -> edit -> add -> delete -> write -> verify file on disk
</verification>

<success_criteria>
- Human verifies all 11 test steps pass
- Editor popup is visually clean and consistent with existing popup styles (wizard, scan config)
- toml_edit preserves comments and formatting after writes
- All EDIT-01 through EDIT-07 requirements are satisfied from the user's perspective
</success_criteria>

<output>
After completion, create `.planning/phases/04-inline-editor/04-03-SUMMARY.md`
</output>
